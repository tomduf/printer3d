<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">
<head>
    <title><%= title %></title>
    <link rel='stylesheet' href='/stylesheets/style.css'/>
</head>
<body>
<div id="instructions">
    <header>
        <h1>Imprimante 3D</h1>
        <h2>Lycée Condorcet - Montreuil</h2>
    </header>
    <div id="main" role="main">
        <ol>
            <li>
                Vérifier que les vignettes ci-dessous correspondent bien aux diapositives à projeter. Elle doivent être déposées dans le dossier <strong>slices</strong> avec un classement
                alphabétique.
            </li>
            <li>
                Prendre les références de l'axe z.
            </li>
            <li>
                Vérifier la quantité de résine.
            </li>
            <li>
                Préparer le kit de nettoyage à température ambiante.
            </li>
            <li>
                Cliquer sur le bouton ci-dessous une première fois pour afficher la mise au point puis appuyer sur Entrée pour lancer
                l'impression.
            </li>
        </ol>
    </div>
    <footer>
        <p>
            <input type="button" value="Afficher la mire" id="boutonMire"/>
        </p>
        <p>
            <%= thumbFichiers.length %> diapositives préchargées
        </p>
    </footer>
</div>
<div id="images">
    <!-- Oouverture de toutes les vignettes -->
    <img src="/images/mire_mise_au_point.png" id="mire"/>
    <% if (thumbFichiers.length) { %>
    <% thumbFichiers.forEach(function(thumbFichier){ %>
    <img src="/thumb-slices/<%= thumbFichier %>" height="40" width="40" class="thumb"/>
    <% }) %>
    <% } %>
    <img id="diapoActive"/>
</div>
<!--! end of #container -->

<!-- JavaScript at the bottom for fast page loading -->

<!-- Grab Google CDN's jQuery, with a protocol relative URL; fall back to local if offline -->
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
<script>
    window.jQuery || document.write('<script src="third_party/jquery-2.1.0.min.js"><\/script>')
</script>

<script>
    $(document).ready(function () {
        var tempoVisible = 3000;
        var tempoCache = 1000;
        var cycleDemarre = false;
        var imageActive = $("#diapoActive");
        var i = 0;
        var nbDiapos = <%=diaposFichiers.length%>;
        // Gestion des événements sur les diapos pour l'affichage de l'état sur Arduino
        imageActive.on('fadein',function(){
            get('/etat');
        });
        // déclaration de la mire comme image active (elle doit être la première image dans le HTML)
        $("#boutonMire").click(function () {// si appui sur le bouton
            $('body').mouseover(function () {// il est important de chacher le curseur pour qu'il ne polymérise pas la résine...
                $(this).css({
                    cursor: 'none'
                });
            }).css("background-color", "black").css("color", "red");
            // arrière-plan rouge avant basculement du miroir et mise au point
            $("#instructions").fadeOut(0, function () {// disparition des consignes
                $('img[class="thumb"]').remove();
                // on libère la mémoire de toutes les vignettes
                $('#mire').fadeIn(2000, function () {// apparition de la mire
                    $("body").keypress(function (e) {
                        if (e.which == 13) {// si appui sur ENTER
                            cycleDemarre = true;
                            $('#mire').fadeOut(2000, function impression() {// fonction récursive qui épuise toutes les images disponibles
                                if (cycleDemarre && i < nbDiapos) {
                                    $.get('/diapo/' + i++, function (diapoActive) {
                                        console.log("> diapositive active n°" + i + "/" + nbDiapos + " : " + diapoActive);
                                        imageActive.attr({
                                            src: '/slices/' + diapoActive
                                        }).delay(tempoCache).fadeIn(0).delay(tempoVisible).fadeOut(0).delay(tempoCache).fadeIn(0).delay(tempoVisible).fadeOut(0).delay(tempoCache).fadeIn(0).delay(tempoVisible).fadeOut(0, impression);
                                    });
                                }
                                else if (i == nbDiapos){ // Appel de la fin d'impression
                                    $.get('/fin', function (textReponse) {
                                        $("#diapoActive").replaceWith('<h1>' + textReponse + '</h1>');
                                    });
                                }
                            });
                        }
                    });
                });
            });
        });
    });
</script>
<!-- end third_party-->

</body>
</html>